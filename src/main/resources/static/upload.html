<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传和解析</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white shadow-md rounded-xl p-8">
            <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">文件上传和解析</h1>

            <div class="space-y-4">
                <label class="block text-sm font-medium text-gray-700">选择文件</label>
                <div class="flex items-center gap-3">
                    <input id="fileInput" type="file" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                </div>
                <p id="fileName" class="text-sm text-gray-500">未选择任何文件</p>

                <button id="parseBtn" disabled class="w-full px-4 py-2 rounded-md bg-blue-500 text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 transition-colors">开始解析</button>
            </div>

            <p id="errorMsg" class="mt-4 text-sm text-red-600 hidden"></p>
        </div>

        <div id="tableSection" class="w-full max-w-4xl mt-8 hidden">
            <div class="bg-white shadow-md rounded-xl p-4 overflow-auto">
                <table id="resultTable" class="min-w-full text-sm text-left text-gray-700">
                    <thead class="bg-gray-100 text-gray-700 font-semibold"></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 遮罩层与浮层（模态） -->
        <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
        <div id="modalRoot" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div id="modalPanel" class="relative bg-white rounded-xl shadow-2xl w-[80vw] h-[80vh] flex flex-col">
                <button id="modalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700" aria-label="关闭">
                    ✕
                </button>
                <div class="px-5 pt-5 pb-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">解析结果</h2>
                </div>
                <div class="p-4 overflow-x-auto overflow-y-auto grow">
                    <table id="modalTable" class="min-w-max text-sm text-left text-gray-700 align-top">
                        <thead class="bg-gray-100 text-gray-700 font-semibold"></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 底部横向进度条（不影响文字排版） -->
        <div id="progressWrap" class="fixed left-0 right-0 bottom-0 z-40 px-4 pb-3 hidden">
            <div id="progressText" class="text-[12px] text-gray-600 mb-1">解析进度 0%</div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-blue-500 rounded-full transition-all" style="width:0%"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const parseBtn = document.getElementById('parseBtn');
        const fileNameEl = document.getElementById('fileName');
        const errorMsg = document.getElementById('errorMsg');
        const tableSection = document.getElementById('tableSection');
        const table = document.getElementById('resultTable');
        const overlay = document.getElementById('overlay');
        const modalRoot = document.getElementById('modalRoot');
        const modalPanel = document.getElementById('modalPanel');
        const modalClose = document.getElementById('modalClose');
        const modalTable = document.getElementById('modalTable');

        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (file) {
                fileNameEl.textContent = file.name;
                parseBtn.disabled = false;
                errorMsg.classList.add('hidden');
            } else {
                fileNameEl.textContent = '未选择任何文件';
                parseBtn.disabled = true;
            }
        });

        parseBtn.addEventListener('click', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const form = new FormData();
            form.append('file', file);

            showProgress(5, '开始上传…');

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/excel/upload-xlsx');
            xhr.responseType = 'json';

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.max(5, Math.min(80, Math.round(e.loaded / e.total * 75) + 5));
                    showProgress(percent, `上传中… ${percent}%`);
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    showProgress(90, '解析中…');
                    const data = xhr.response || {};
                    const headers = (data.columns || []).map(c => c.headerName);
                    const rows = data.rows || [];
                    renderTableInModal(headers, rows);
                    showProgress(100, '完成');
                    setTimeout(hideProgress, 800);
                } else {
                    hideProgress();
                    showError('解析失败：服务器返回错误 ' + xhr.status);
                }
            };

            xhr.onerror = () => {
                hideProgress();
                showError('解析失败：网络错误');
            };

            xhr.send(form);
        });

        // 客户端不再解析，交由后端处理

        function renderTable(headers, rows) {
            // 清理
            table.querySelector('thead').innerHTML = '';
            table.querySelector('tbody').innerHTML = '';

            // 头
            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 border-b border-gray-200';
                th.textContent = h;
                trHead.appendChild(th);
            });
            table.querySelector('thead').appendChild(trHead);

            // 体
            rows.forEach(r => {
                const tr = document.createElement('tr');
                r.forEach(c => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 border-b border-gray-100';
                    td.textContent = c;
                    tr.appendChild(td);
                });
                table.querySelector('tbody').appendChild(tr);
            });

            errorMsg.classList.add('hidden');
            tableSection.classList.remove('hidden');
        }

        function renderTableInModal(headers, rows) {
            // 清理
            modalTable.querySelector('thead').innerHTML = '';
            modalTable.querySelector('tbody').innerHTML = '';

            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 border-b border-gray-200 whitespace-nowrap';
                th.textContent = h;
                trHead.appendChild(th);
            });
            modalTable.querySelector('thead').appendChild(trHead);

            rows.forEach(r => {
                const tr = document.createElement('tr');
                r.forEach(c => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 border-b border-gray-100 whitespace-nowrap';
                    td.textContent = c;
                    tr.appendChild(td);
                });
                modalTable.querySelector('tbody').appendChild(tr);
            });

            openModal();
        }

        function openModal() {
            overlay.classList.remove('hidden');
            modalRoot.classList.remove('hidden');
            modalRoot.classList.add('flex');
        }

        function closeModal() {
            overlay.classList.add('hidden');
            modalRoot.classList.add('hidden');
            modalRoot.classList.remove('flex');
        }

        overlay.addEventListener('click', closeModal);
        modalClose.addEventListener('click', closeModal);
        // 阻止点击面板冒泡到遮罩关闭
        modalPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 进度条控制
        function showProgress(percent, text) {
            const wrap = document.getElementById('progressWrap');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');
            wrap.classList.remove('hidden');
            bar.style.width = Math.max(0, Math.min(100, percent)) + '%';
            if (text) txt.textContent = `解析进度 ${Math.max(0, Math.min(100, percent))}% · ${text}`;
        }

        function hideProgress() {
            const wrap = document.getElementById('progressWrap');
            wrap.classList.add('hidden');
            // 重置
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '解析进度 0%';
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
            tableSection.classList.add('hidden');
        }
    </script>
</body>
</html>

