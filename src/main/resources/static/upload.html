<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传和解析</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen" style="background: linear-gradient(135deg, rgb(240, 246, 254) 0%, rgb(225, 231, 253) 100%);">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div
            class="w-full max-w-xl bg-white shadow-lg rounded-xl p-8 transition-all duration-300 hover:shadow-xl hover:scale-105">
            <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">文件上传和解析</h1>

            <div class="space-y-4">
                <!-- 隐藏的原生文件输入 -->
                <input id="fileInput" type="file" accept=".xlsx,.xls,.txt" class="hidden" />

                <!-- 自定义拖拽上传区域 -->
                <div id="uploadArea"
                    class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 group">
                    <div class="flex flex-col items-center space-y-3">
                        <!-- 上传图标 -->
                        <div
                            class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center group-hover:bg-blue-200 transition-colors duration-300">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                </path>
                            </svg>
                        </div>

                        <!-- 上传文本 -->
                        <div>
                            <p
                                class="text-lg font-medium text-gray-700 group-hover:text-blue-600 transition-colors duration-300">
                                点击此处或拖拽文件上传</p>
                            <p class="text-sm text-gray-500 mt-1">支持 .xlsx, .xls, .txt 格式</p>
                        </div>
                    </div>

                    <!-- 拖拽覆盖层 -->
                    <div id="dragOverlay"
                        class="absolute inset-0 bg-blue-100 bg-opacity-80 rounded-lg flex items-center justify-center hidden">
                        <p class="text-blue-600 font-medium">释放文件开始上传</p>
                    </div>
                </div>

                <p id="fileName" class="text-sm text-gray-500 text-center">未选择任何文件</p>

                <button id="parseBtn" disabled
                    class="w-full px-4 py-2 rounded-md bg-blue-500 text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 hover:scale-105 transition-all duration-200">开始解析</button>
            </div>

            <p id="errorMsg" class="mt-4 text-sm text-red-600 hidden"></p>
        </div>

        <div id="tableSection" class="w-full max-w-4xl mt-8 hidden">
            <div class="bg-white shadow-lg rounded-xl p-4 overflow-auto transition-all duration-300 hover:shadow-xl">
                <table id="resultTable" class="min-w-full text-sm text-left text-gray-700">
                    <thead class="bg-gray-100 text-gray-700 font-semibold"></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 遮罩层与浮层（模态） -->
        <div id="overlay" class="fixed inset-0 bg-transparent z-40 hidden"></div>
        <div id="modalRoot" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div id="modalPanel"
                class="relative bg-white border border-gray-200 rounded-xl shadow-2xl w-[80vw] h-[90vh] flex flex-col transition-all duration-300">
                <button id="modalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700"
                    aria-label="关闭">
                    ✕
                </button>
                <div class="px-5 pt-5 pb-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">解析结果</h2>
                </div>
                <div class="p-4 grow flex flex-col min-h-0">
                    <div id="tabBar" class="flex gap-3 mb-3 flex-wrap"></div>
                    <div id="tabContent"
                        class="bg-white border border-gray-300 rounded-lg p-3 overflow-x-auto overflow-y-auto flex-1 min-h-0">
                        <table id="modalTable" class="min-w-max text-sm text-left text-gray-700 align-top">
                            <thead class="bg-gray-100 text-gray-700 font-semibold"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部横向进度条（不影响文字排版） -->
        <div id="progressWrap" class="fixed left-0 right-0 bottom-0 z-40 px-4 pb-3 hidden">
            <div id="progressText" class="text-[12px] text-gray-600 mb-1">解析进度 0%</div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-blue-500 rounded-full transition-all" style="width:0%"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const dragOverlay = document.getElementById('dragOverlay');
        const parseBtn = document.getElementById('parseBtn');
        const fileNameEl = document.getElementById('fileName');
        const errorMsg = document.getElementById('errorMsg');
        const tableSection = document.getElementById('tableSection');
        const table = document.getElementById('resultTable');
        const overlay = document.getElementById('overlay');
        const modalRoot = document.getElementById('modalRoot');
        const modalPanel = document.getElementById('modalPanel');
        const modalClose = document.getElementById('modalClose');
        const modalTable = document.getElementById('modalTable');
        const tabBar = document.getElementById('tabBar');
        const tabContent = document.getElementById('tabContent');

        // 文件选择处理函数
        function handleFileSelect(file) {
            if (file) {
                fileNameEl.textContent = `已选择: ${file.name}`;
                parseBtn.disabled = false;
                errorMsg.classList.add('hidden');
                uploadArea.classList.add('border-green-400', 'bg-green-50');
                uploadArea.classList.remove('border-gray-300');
            } else {
                fileNameEl.textContent = '未选择任何文件';
                parseBtn.disabled = true;
                uploadArea.classList.remove('border-green-400', 'bg-green-50');
                uploadArea.classList.add('border-gray-300');
            }
        }

        // 原生文件输入变化事件
        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            handleFileSelect(file);
        });

        // 点击上传区域触发文件选择
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 拖拽事件处理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            dragOverlay.classList.remove('hidden');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            if (!uploadArea.contains(e.relatedTarget)) {
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                dragOverlay.classList.add('hidden');
            }
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            dragOverlay.classList.add('hidden');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const allowedTypes = ['.xlsx', '.xls', '.txt'];
                const fileName = file.name.toLowerCase();
                const isValidType = allowedTypes.some(type => fileName.endsWith(type));

                if (isValidType) {
                    fileInput.files = files;
                    handleFileSelect(file);
                } else {
                    showError('请选择 .xlsx, .xls 或 .txt 格式的文件');
                }
            }
        });

        parseBtn.addEventListener('click', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            const form = new FormData();
            form.append('file', file);

            showProgress(5, '开始上传…');

            const xhr = new XMLHttpRequest();
            const nameLower = (file.name || '').toLowerCase();
            const isTxt = nameLower.endsWith('.txt');
            const endpoint = isTxt ? '/txt/upload' : '/excel/upload-xlsx-sheets';
            xhr.open('POST', endpoint);
            xhr.responseType = 'json';

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.max(5, Math.min(80, Math.round(e.loaded / e.total * 75) + 5));
                    showProgress(percent, `上传中… ${percent}%`);
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    showProgress(90, '解析中…');
                    const data = xhr.response;
                    if (isTxt) {
                        const headers = ((data && data.columns) || []).map(c => c.headerName);
                        const rows = (data && data.rows) || [];
                        renderTableInModal(headers, rows);
                    } else {
                        const list = Array.isArray(data) ? data : [];
                        renderMultiSheetInModal(list);
                    }
                    showProgress(100, '完成');
                    setTimeout(hideProgress, 800);
                } else {
                    hideProgress();
                    showError('解析失败：服务器返回错误 ' + xhr.status);
                }
            };

            xhr.onerror = () => {
                hideProgress();
                showError('解析失败：网络错误');
            };

            xhr.send(form);
        });

        // 客户端不再解析，交由后端处理

        function renderTable(headers, rows) {
            // 清理
            table.querySelector('thead').innerHTML = '';
            table.querySelector('tbody').innerHTML = '';

            // 头
            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 border-b border-gray-200';
                th.textContent = h;
                trHead.appendChild(th);
            });
            table.querySelector('thead').appendChild(trHead);

            // 体
            rows.forEach(r => {
                const tr = document.createElement('tr');
                r.forEach(c => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 border-b border-gray-100';
                    td.textContent = c;
                    tr.appendChild(td);
                });
                table.querySelector('tbody').appendChild(tr);
            });

            errorMsg.classList.add('hidden');
            tableSection.classList.remove('hidden');
        }

        function renderTableInModal(headers, rows) {
            // 清理
            tabBar.innerHTML = '';
            modalTable.querySelector('thead').innerHTML = '';
            modalTable.querySelector('tbody').innerHTML = '';

            if (headers && headers.length > 0) {
                const trHead = document.createElement('tr');
                // 行号表头
                const thIndex = document.createElement('th');
                thIndex.className = 'px-0 py-2 border-b border-gray-200 whitespace-nowrap text-gray-500 text-center bg-gray-100';
                thIndex.style.width = '30px';
                thIndex.textContent = '';
                trHead.appendChild(thIndex);
                headers.forEach(h => {
                    const th = document.createElement('th');
                    th.className = 'px-3 py-2 border-b border-gray-200 whitespace-nowrap';
                    th.textContent = h;
                    trHead.appendChild(th);
                });
                modalTable.querySelector('thead').appendChild(trHead);
            }

            rows.forEach(r => {
                const tr = document.createElement('tr');
                // 行号单元
                const tdIndex = document.createElement('td');
                tdIndex.className = 'px-0 py-2 border-b border-gray-100 whitespace-nowrap text-gray-500 text-center bg-gray-100';
                tdIndex.style.width = '30px';
                tdIndex.textContent = String((modalTable.querySelector('tbody').children.length || 0) + 1);
                tr.appendChild(tdIndex);
                r.forEach(c => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 border-b border-gray-100 whitespace-nowrap';
                    td.textContent = c;
                    tr.appendChild(td);
                });
                modalTable.querySelector('tbody').appendChild(tr);
            });

            openModal();
        }

        function renderMultiSheetInModal(results) {
            // 清理
            modalTable.querySelector('thead').innerHTML = '';
            modalTable.querySelector('tbody').innerHTML = '';
            tabBar.innerHTML = '';

            if (!Array.isArray(results) || results.length === 0) {
                openModal();
                return;
            }

            // 构建 tabs
            results.forEach((res, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:scale-105';
                btn.textContent = res.sheetName || `Sheet ${idx + 1}`;
                btn.addEventListener('click', () => selectSheet(idx));
                tabBar.appendChild(btn);
            });

            function selectSheet(index) {
                const res = results[index];
                const headers = (res.columns || []).map(c => c.headerName);
                const rows = res.rows || [];

                // 高亮当前 tab
                Array.from(tabBar.children).forEach((el, i) => {
                    el.className = 'px-3 py-1 rounded border transition-all duration-200 hover:scale-105 ' + (i === index
                        ? 'border-blue-500 text-blue-700 bg-blue-50'
                        : 'border-gray-300 text-gray-700 hover:bg-gray-100');
                });

                // 重绘表格
                modalTable.querySelector('thead').innerHTML = '';
                modalTable.querySelector('tbody').innerHTML = '';

                if (headers.length > 0) {
                    const trHead = document.createElement('tr');
                    // 行号表头
                    const thIndex = document.createElement('th');
                    thIndex.className = 'px-0 py-2 border-b border-gray-200 whitespace-nowrap text-gray-500 text-center bg-gray-100';
                    thIndex.style.width = '30px';
                    thIndex.textContent = '';
                    trHead.appendChild(thIndex);
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.className = 'px-3 py-2 border-b border-gray-200 whitespace-nowrap';
                        th.textContent = h;
                        trHead.appendChild(th);
                    });
                    modalTable.querySelector('thead').appendChild(trHead);
                }

                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    // 行号单元
                    const tdIndex = document.createElement('td');
                    tdIndex.className = 'px-0 py-2 border-b border-gray-100 whitespace-nowrap text-gray-500 text-center bg-gray-100';
                    tdIndex.style.width = '30px';
                    tdIndex.textContent = String((modalTable.querySelector('tbody').children.length || 0) + 1);
                    tr.appendChild(tdIndex);
                    r.forEach(c => {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 border-b border-gray-100 whitespace-nowrap';
                        td.textContent = c;
                        tr.appendChild(td);
                    });
                    modalTable.querySelector('tbody').appendChild(tr);
                });
            }

            // 默认选中第一个 sheet
            selectSheet(0);
            openModal();
        }

        function openModal() {
            overlay.classList.remove('hidden');
            modalRoot.classList.remove('hidden');
            modalRoot.classList.add('flex');
        }

        function closeModal() {
            overlay.classList.add('hidden');
            modalRoot.classList.add('hidden');
            modalRoot.classList.remove('flex');
        }

        overlay.addEventListener('click', closeModal);
        modalClose.addEventListener('click', closeModal);
        // 阻止点击面板冒泡到遮罩关闭
        modalPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 进度条控制
        function showProgress(percent, text) {
            const wrap = document.getElementById('progressWrap');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');
            wrap.classList.remove('hidden');
            bar.style.width = Math.max(0, Math.min(100, percent)) + '%';
            if (text) txt.textContent = `解析进度 ${Math.max(0, Math.min(100, percent))}% · ${text}`;
        }

        function hideProgress() {
            const wrap = document.getElementById('progressWrap');
            wrap.classList.add('hidden');
            // 重置
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '解析进度 0%';
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
            tableSection.classList.add('hidden');
        }
    </script>
</body>

</html>